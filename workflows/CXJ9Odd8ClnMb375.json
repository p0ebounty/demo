{
  "id": "CXJ9Odd8ClnMb375",
  "name": "Agent Contact",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "contact_id",
              "type": "number"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -880,
        -112
      ],
      "id": "64d49807-f56f-4922-99a3-c0d1b1ad1666",
      "name": "start"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cec8816c-5378-4f51-a2d6-33ab40f3529f",
              "leftValue": "={{ $node[\"get contact\"].json[\"Agent\"][\"0\"][\"id\"] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -448,
        -112
      ],
      "id": "3df730b9-b843-48df-b148-f1df1bf84423",
      "name": "exists?"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "workspaceId": "wqp6q0zt",
        "projectId": "p0a3eirwme1bmw7",
        "table": "mrvcxcj5helhdz3",
        "limit": 1,
        "options": {
          "where": "=(Account,eq,{{ $node[\"get contact\"].json[\"Agent\"][\"0\"][\"id\"] }})"
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        -208,
        -128
      ],
      "id": "bfffff50-c836-496b-ab0e-ffb9a6be284c",
      "name": "get agent data",
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "tg1sd8Mux2yjJLx7",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f0f83613-8139-4e84-b60b-ad81d2d755ce",
              "leftValue": "={{ $json.Account[0].id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        -128
      ],
      "id": "508514a7-14e9-4384-89c6-a4bc194cdaa4",
      "name": "check agent record"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "workspaceId": "wqp6q0zt",
        "projectId": "p0a3eirwme1bmw7",
        "table": "mrvcxcj5helhdz3",
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        -512,
        352
      ],
      "id": "d14e43a7-1e55-4bf1-ac5d-7f5e0c9a1f72",
      "name": "get agents",
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "tg1sd8Mux2yjJLx7",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "workspaceId": "wqp6q0zt",
        "projectId": "p0a3eirwme1bmw7",
        "table": "mrvcxcj5helhdz3",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Id",
              "fieldValue": "={{ $json.agent.Id }}"
            },
            {
              "fieldName": "ts",
              "fieldValue": "={{ Math.floor(Date.now() / 1000) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        240,
        336
      ],
      "id": "b89d03eb-e838-43bc-afeb-b0bf57cac149",
      "name": "update ts agent",
      "credentials": {
        "nocoDbApiToken": {
          "id": "tg1sd8Mux2yjJLx7",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eb461de7-24ef-4d06-b6a0-7ac28d5fd982",
              "leftValue": "={{ $json.success }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -32,
        352
      ],
      "id": "5dc6699f-b9d6-4db1-b1f6-442c7a04f44a",
      "name": "success?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "af49c6fd-21be-4d74-a076-dc0bb281b8a8",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "0d158427-3f0e-468c-a446-44bb48b95297",
              "name": "agent",
              "value": "={{ $json.agent || $json }}",
              "type": "object"
            },
            {
              "id": "b4d3fc33-f1c7-4ee2-aa2c-ccedf2e08066",
              "name": "tg",
              "value": "={{ ($json.agent?.Telegram || $json.Telegram) ? '@' + ($json.agent?.Telegram || $json.Telegram).toString().replace(/^@+|https?:\\/\\/(t\\.me\\/|telegram\\.me\\/)/g, '') : null }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -32,
        784
      ],
      "id": "10da9035-6920-46d3-a194-c047aefbc025",
      "name": "output ok"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "caad9a66-8008-4030-82c7-86fae65bb290",
              "name": "success",
              "value": "={{ $json.success }}",
              "type": "boolean"
            },
            {
              "id": "b3524cda-c9cb-48bc-93ab-38a223f751d3",
              "name": "error",
              "value": "={{ $json.reason || $json.error }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -32,
        608
      ],
      "id": "0044de5f-64dc-4b51-a26c-7da6b21e821a",
      "name": "output bad"
    },
    {
      "parameters": {
        "chatId": "={{ $vars.warngroup }}",
        "text": "=ðŸŽ¯ New Contact Assigned (Contacts)!\n-------------\nðŸ‘¤ Contact: {{ $node[\"get contact\"].json[\"Name\"] || \"-\" }}\nðŸ“§ Email: {{ $node[\"get contact\"].json[\"Email\"] || \"-\" }}\nðŸ“± Phone: {{ $node[\"get contact\"].json[\"Phone\"] || \"-\" }}\n-------------\n\nðŸ‘¨â€ðŸ’¼ Assigned: \n- {{ $node[\"agent selection\"].json[\"agent\"][\"Account\"][\"0\"][\"display_name\"] || \"-\" }}\n- {{ $node[\"agent selection\"].json[\"agent\"][\"Account\"][\"0\"][\"email\"] || \"-\" }}\n- {{ ($node[\"get agents\"].json[\"Telegram\"]) ? '@' + ($node[\"get agents\"].json[\"Telegram\"]).toString().replace(/^@+|https?:\\/\\/(t\\.me\\/|telegram\\.me\\/)/g, '') : \"No username\" }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Open",
                    "additionalFields": {
                      "url": "={{ $vars.nocodb_url_ex }}#/wqp6q0zt/p0a3eirwme1bmw7/meyq439syguvqhb?rowId={{ $node[\"get contact\"].json[\"Id\"] }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "message_thread_id": 83
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        656,
        336
      ],
      "id": "79d4e2c3-c936-4e66-9c94-11aead6a11f6",
      "name": "noti to event",
      "webhookId": "b2f97887-034a-47e7-bdb4-75327f72f103",
      "credentials": {
        "telegramApi": {
          "id": "yv48JNV4VmuIREaW",
          "name": "Citycompany"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "workspaceId": "wqp6q0zt",
        "projectId": "p0a3eirwme1bmw7",
        "table": "meyq439syguvqhb",
        "id": "={{ $node[\"start\"].json[\"contact_id\"] }}"
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        -656,
        -112
      ],
      "id": "01e5b3c3-6a42-4d54-8aa9-a227780d401a",
      "name": "get contact",
      "credentials": {
        "nocoDbApiToken": {
          "id": "tg1sd8Mux2yjJLx7",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°Ð¼Ð¸\nconst contactData = $node[\"get contact\"].json;\nconst contact = Array.isArray(contactData) ? contactData[0] : contactData;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹\nif (!contact) {\n  return {\n    json: {\n      success: false,\n      error: 'No Contact data received'\n    }\n  };\n}\n\n// Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ $items Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð’Ð¡Ð•Ð¥ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…\nconst agentsItems = $items(\"get agents\");\nlet agents = agentsItems ? agentsItems.map(item => item.json) : [];\n\n// Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð² - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ðµ Ñƒ ÐºÐ¾Ð³Ð¾ ÐµÑÑ‚ÑŒ Account\nagents = agents.filter(agent => {\n  return agent.Account && \n         Array.isArray(agent.Account) && \n         agent.Account.length > 0;\n});\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð°Ð³ÐµÐ½Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹\nif (!agents || agents.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: 'No agents available with Account',\n      contactId: contact.Id\n    }\n  };\n}\n\n// Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ts (null ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ°Ðº ÑÐ°Ð¼Ð¾Ðµ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ - Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚)\nagents.sort((a, b) => {\n  if (a.ts === null && b.ts === null) return 0;\n  if (a.ts === null) return -1;\n  if (b.ts === null) return 1;\n  return a.ts - b.ts;\n});\n\nconst agent = agents[0];\n\nreturn {\n  json: {\n    success: true,\n    contactId: contact.Id,\n    agent: {\n      ...agent\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        352
      ],
      "id": "bd0ae571-cab3-4f63-a968-4d27344d3483",
      "name": "agent selection"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "workspaceId": "wqp6q0zt",
        "projectId": "p0a3eirwme1bmw7",
        "table": "meyq439syguvqhb",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Id",
              "fieldValue": "={{ $node[\"get contact\"].json[\"Id\"] }}"
            },
            {
              "fieldName": "Agent",
              "fieldValue": "={{ $('success?').item.json.agent.Account[0].id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        448,
        336
      ],
      "id": "033277f1-0716-4fd3-b2e4-c8dcf00c16ff",
      "name": "agent to contact",
      "credentials": {
        "nocoDbApiToken": {
          "id": "tg1sd8Mux2yjJLx7",
          "name": "NocoDB"
        }
      }
    }
  ],
  "connections": {
    "start": {
      "main": [
        [
          {
            "node": "get contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "exists?": {
      "main": [
        [
          {
            "node": "get agent data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get agents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get agent data": {
      "main": [
        [
          {
            "node": "check agent record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check agent record": {
      "main": [
        [
          {
            "node": "output ok",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get agents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get agents": {
      "main": [
        [
          {
            "node": "agent selection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update ts agent": {
      "main": [
        [
          {
            "node": "agent to contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "success?": {
      "main": [
        [
          {
            "node": "update ts agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "output ok",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "output bad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get contact": {
      "main": [
        [
          {
            "node": "exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agent selection": {
      "main": [
        [
          {
            "node": "success?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agent to contact": {
      "main": [
        [
          {
            "node": "noti to event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "EuAkMSh7w9p9TJgj"
  },
  "triggerCount": 0,
  "versionId": "cf996a46-199a-461d-b394-9afddf202c83",
  "owner": {
    "type": "personal",
    "projectId": "I8ZweZXokOc0zbYb",
    "projectName": "BSU Agency <info@brilliantseedup.com>",
    "personalEmail": "info@brilliantseedup.com"
  },
  "parentFolderId": "HWn7vIRYn4vaHZR5",
  "isArchived": false
}